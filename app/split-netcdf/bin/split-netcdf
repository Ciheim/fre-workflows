#!/bin/bash
set -euo pipefail
set -x

#
# Split NetCDF files by variable
#
# Can be tiled or not. Component is optional, defaults to all.
#
# Input format:  date.component(.tileX).nc
# Output format: date.component.var(.tileX).nc
#

echo Arguments:
echo "    input dir: $inputDir"
echo "    output dir: $outputDir"
echo "    date: $date"
echo "    component: $component"
echo "    use subdirs: ${use_subdirs:=}"
echo Utilities:
type cdo

# Verify input directory exists and is a directory
if [[ ! -d $inputDir ]]; then
    err "Error: Input directory '${inputDir}' does not exist or isn't a directory"
    exit 1
fi

# Verify output directory exists and is a directory
if [[ ! -d $outputDir ]]; then
    err "Error: Output directory '${outputDir}' does not exist or isn't a directory"
    exit 1
fi

# Find the files to split
# extended globbing used to find both tiled and non-tiled files
cd $inputDir
shopt -s extglob

# If in sub-dir mode, process the sub-directories instead of the main one
if [[ $use_subdirs ]]; then
    for subdir in $(ls); do
        pushd $subdir
        files=$(echo *.$component?(.tile?).nc)

        # Exit if no input files are found
        if [[ $files =~ \* ]]; then
            err No input files found, skipping the subdir "$subdir"
            popd
            continue
        fi

        # Create the output subdir if needed
        mkdir -p $outputDir/$subdir

        # Split the files by variable
        # Note: cdo may miss some weird land variables related to metadata/cell_measures
        for file in $files; do
            cdo --history splitname $file $outputDir/$subdir/$(echo $file | sed 's/nc$//')
        done

        popd
    done
else
    files=$(echo *.$component?(.tile?).nc)

    # Exit if no input files are found
    if [[ $files =~ \* ]]; then
        err ERROR: No input files found
        exit 1
    fi

    # Split the files by variable
    for file in $files; do
        cdo --history splitname $file $outputDir/$(echo $file | sed 's/nc$//')
    done
fi

echo Natural end of the NetCDF splitting
exit 0
