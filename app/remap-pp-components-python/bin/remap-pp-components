#!/usr/bin/env python

# Description: Remap pp components 

import os
import glob
import sys
from pathlib import Path
import shared
import metomi.rose.config as mrc

# Set variables to play with
inputDir = Path(os.getcwd()) / "rewrite_inputDir"
outputDir = Path(os.getcwd()) / "rewrite_outputDir"
begin = "00010101T0000Z" 
currentChunk = "P1Y"
components = ["atmos", "atmos_cmip", "ocean"]
#components = ["land" ,"atmos_scalar"]
product = "ts"
dirTSWorkaround = ""
#dirTSWorkaround = "1"
ens_mem = "" 
#ens_mem = "01"


##################################

# Parse yaml directly for rose-app info
#use configure to parse and save variables???? then use variables in here?

# Set variables
#inputDir = os.environ['inputDir']
#outputDir = os.environ['outputDir']
#begin = os.environ['begin']
#currentChunk = os.environ['currentChunk']
#components = os.environ['component']
#product = os.environ['product']
#dirTSWorkaround = os.environ['dirTSWorkaround']
#ens_mem = os.environ['ens_mem']

#print("Arguments:")
#print("    input dir: "+inputDir)
#print("    output dir: "+outputDir)
#print("    begin: "+begin)
#print("    current chunk: "+currentChunk)
#print("    components: "+components)
#print("    product: "+product)
#print("    dirTSWorkaround: "+dirTSWorkaround)
#print("    ens_mem: "+ens_mem)
#print("Utilities:")
#
#COPY_TOOL = os.environ['COPY_TOOL']
#type(COPY_TOOL)

##############################################################

def bronx_style(freq, chunk, ens_member, outDir, component):
  freq_legacy = shared.freq_to_legacy(freq)
  chunk_legacy = shared.chunk_to_legacy(chunk)
  if chunk_legacy == "error":
    print(f"Error: Skipping legacy directory for chunk: {chunk}")
  else:
    if ens_member:
      dir1 = f"{outDir}/{component}/ts/{ens_member}"
      os.chdir(f"{outDir}/{component}/ts/{ens_member}")
    else:
      dir1 = f"{outDir}/{component}/ts"
      os.chdir(f"{outDir}/{component}/ts")
    
    os.makedirs(freq_legacy, exist_ok=True)
    os.chdir(freq_legacy)
    
    if not os.path.exists(chunk_legacy):
      os.symlink(f"{dir1}/{freq}/{chunk}", chunk_legacy)

##############################################################

def remap(inputDir,outputDir,begin,currentChunk,components,product,dirTSWorkaround,ens_mem):
  # Verify input directory exists and is a directory
  if os.path.isdir(inputDir):
      print("Input directory is a valid directory")
  else:
      print(f"Error: Input directory {inputDir} is not a valid directory")
      sys.exit(1)

  # Verify output directory exists and is a directory
  if os.path.isdir(outputDir):
      print("Output directory is a valid directory")
  else:
      print(f"Error: Output directory {outputDir} is not a valid directory")
      sys.exit(1)

##############################################################

  # Read rose config files (for now)
  # Define config file
  # JUST FOR DEVELOPMENT
  #config = mrc.load("/home/Dana.Singh/pp/refactor/REMAP/app/remap-pp-components-python/rose-app-run.conf")
  config = mrc.load("/home/Dana.Singh/pp/refactor/REMAP/app/remap-pp-components-python/bin/rose-app.conf")
 
  for comp in config.get():
    #print(config.get())
    os.chdir(inputDir)
    if comp != "env" and comp != "command":
      #print(comp)
      if components != None and comp not in components:
        continue  
   
      #compOut: variable/field per component in rose config
      compOut = config.get([comp])

      #fields: info for each field 
      fields = compOut.get_value()

      ## Define vars
      if fields.get("variables"):
        vars = fields.get("variables").get_value()
        vars = vars.split()
      else:
        vars = "all"

      #GRID
      if fields.get("grid"):
        grid = fields.get("grid").get_value()
        if ens_mem != None:
          newdir = f"{grid}/{ens_mem}"
          os.makedirs(newdir,exist_ok=True)
          os.chdir(newdir)
        else:
          os.makedirs(grid,exist_ok=True)
          os.chdir(grid)

        #SOURCES
        if fields.get("sources"):
          sources = fields.get("sources").get_value()
          sources = sources.split()
        
        cgd = os.getcwd()
        print(cgd) 
        for s in sources:
          # start in regrid directory 
          os.chdir(cgd)
          # go into source directory 
          os.makedirs(s,exist_ok=True)
          os.chdir(s)
          
          #FREQ
          if fields.get("freq"):
            freq = fields.get("freq").get_value()
            #print(freq)
            os.makedirs(freq,exist_ok=True)
            os.chdir(freq)

            #CHUNK
            if fields.get("chunk"):
              chunk = fields.get("chunk").get_value()
              os.makedirs(chunk,exist_ok=True)
              os.chdir(chunk)

              # DEFINE DIR
              if ens_mem:
                if dirTSWorkaround:
                  dir = f"{outputDir}/{comp}/ts/{ens_mem}/{freq}/{chunk}"
                else:
                  dir = f"{outputDir}/{comp}/{ens_mem}/{freq}/{chunk}"
              else:
                if dirTSWorkaround:
                  dir = f"{outputDir}/{comp}/ts/{freq}/{chunk}" 
                  #print(dir)
                else:
                  dir = f"{outputDir}/{comp}/{freq}/{chunk}"
          
              os.makedirs(dir,exist_ok=True)

              # Create bronx-style symlinks for TS only
              if dirTSWorkaround:
                bronx_style(freq = freq, 
                            chunk = chunk, 
                            ens_member = ens_mem,
                            outDir = outputDir,
                            component = comp)

              # with glob - files seen as list
              if freq == "P0Y":
                if vars == "all":
                  files = glob.glob(f"{s}.*.tile?.nc")
                  #print(files)
                else:
                  for v in vars:
                    files = glob.glob(f"{s}.{v}?.tile?.nc")
              else:
                if product == "ts":
                  date = shared.truncate_date(begin, freq)
                elif product == "av":
                  date = shared.truncate_date(begin, "P1Y")
                else:
                  print("Product not set to ts or av.")
                  sys.exit(2)

                if vars == "all":
                  files = glob.glob(f"{s}/{date1}-*.tile?.nc")
                else:
                  files = ""
                  for v in vars:
                    files = glob.glob(f"{s}.{date1}-*.{v}?.tile?.nc")

                if product == "av" and currentChunk == "P1Y":
                  files = glob.glob(f"{s}.{date1}.*.tile?.nc")
	
              if not files:
                print(f"\nError: No input files found in {os.getcwd()}")
                sys.exit(1)
              else:
                for f in files:
                  newfile = f"{comp}.{f}"

                  if os.path.exists(f"{dir}/{newfile}"):
                    os.remove(f"{dir}/{newfile}")
                
                  #soft link
                  os.symlink(f"{os.getcwd()}/{f}",f"{dir}/{newfile}") 
                  ## OR COPY TOOL??????           

  print("Component remapping complete")

if __name__ == '__main__':
   remap(inputDir,outputDir,begin,currentChunk,components,product,dirTSWorkaround,ens_mem)

