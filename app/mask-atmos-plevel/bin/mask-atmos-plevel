#!/bin/bash
set -euo pipefail
set -x

#
# Mask atmos plevel files below surface pressure
#

export input_file_list=
export output_file_list=
echo "[COLE] created i/o lists"

echo Arguments:
echo "    input dir: $inputDir"
echo "    component(s): $component"
echo Utilities:
type python
type refine_Atmos_no_redux.py

# Verify input directory exists and is a directory
if [[ ! -d $inputDir ]]; then
    err "Error: Input directory '${inputDir}' does not exist or isn't a directory"
    exit 1
fi

cd $inputDir

for file in $(ls *.$component.*.nc); do

    current_loc=$(pwd)
    cd $inputDir
        hash_val=$(/home/Cole.Harvey/.conda/envs/bloom-filter-env/bin/python /home/Cole.Harvey/postprocessing/data_lineage/bloomfilter/HashGen.py $file)
        export input_file_list="${input_file_list}$file  $hash_val,"
        echo -e "\n[COLE] added $file to input list with hash_val: $hash_val"
    cd $current_loc

    refine_Atmos_no_redux.py $file -o $file.masked -p $file
    if [[ -f $file.masked ]]; then
        mv -f $file.masked $file
        echo "Updated '$file'"
    fi

    # output files, although named the same as the input files, may have different contents so their
    # checksums need to be calculated as well
    cd $inputDir
        hash_val=$(/home/Cole.Harvey/.conda/envs/bloom-filter-env/bin/python /home/Cole.Harvey/postprocessing/data_lineage/bloomfilter/HashGen.py $file)
        export output_file_list="${output_file_list}$file  $hash_val,"
        echo -e "\n[COLE] added $file to output list with hash_val: $hash_val"
    cd $current_loc
done

echo "[COLE] epmt analysis and annotate"
which epmt

if [[ -n "$input_file_list" ]]; then
    echo -e "\n---input---"
    echo -e "epmt annotate DATA_LINEAGE_IN = \n	${input_file_list%*,}"
    epmt annotate EPMT_DATA_LINEAGE_IN="${input_file_list%*,}"
fi

if [ -n "$output_file_list" ]; then
    echo -e "\n---output---"
    echo -e "epmt annotate DATA_LINEAGE_OUT = \n    ${output_file_list%*,}"
    epmt annotate EPMT_DATA_LINEAGE_OUT="${output_file_list%*,}"
fi

echo Natural end of the atmos plevel masking
exit 0
